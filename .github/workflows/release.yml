name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libraylib-dev
          
      - name: Build
        run: make
        
      - name: Create DEB package
        run: |
          mkdir -p typit_${{ github.ref_name }}_amd64/DEBIAN
          mkdir -p typit_${{ github.ref_name }}_amd64/usr/bin
          mkdir -p typit_${{ github.ref_name }}_amd64/usr/share/typit
          
          cp build/typer typit_${{ github.ref_name }}_amd64/usr/bin/typit
          cp -r resources typit_${{ github.ref_name }}_amd64/usr/share/typit/
          
          cat > typit_${{ github.ref_name }}_amd64/DEBIAN/control << EOF
          Package: typit
          Version: ${{ github.ref_name }}
          Section: games
          Priority: optional
          Architecture: amd64
          Depends: libraylib-dev
          Maintainer: SalvatoreBia
          Description: A terminal-inspired typing test application
           A typing test built with raylib.
          EOF
          
          dpkg-deb --build typit_${{ github.ref_name }}_amd64
          
      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: typit-deb
          path: typit_${{ github.ref_name }}_amd64.deb

  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          dnf install -y gcc make raylib-devel rpm-build
          
      - name: Build
        run: make
        
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p ~/rpmbuild/BUILDROOT/typit-1.0-1.x86_64/usr/bin
          mkdir -p ~/rpmbuild/BUILDROOT/typit-1.0-1.x86_64/usr/share/typit
          
          cp build/typer ~/rpmbuild/BUILDROOT/typit-1.0-1.x86_64/usr/bin/typit
          cp -r resources ~/rpmbuild/BUILDROOT/typit-1.0-1.x86_64/usr/share/typit/
          
          cat > ~/rpmbuild/SPECS/typit.spec << 'EOF'
          Name: typit
          Version: 1.0
          Release: 1
          Summary: A terminal-inspired typing test application
          License: MIT
          
          %description
          MonkeyType-style typing test built with raylib.
          
          %files
          /usr/bin/typit
          /usr/share/typit/resources
          EOF
          
          rpmbuild -bb ~/rpmbuild/SPECS/typit.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm ./typit-${{ github.ref_name }}.x86_64.rpm
          
      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: typit-rpm
          path: typit-${{ github.ref_name }}.x86_64.rpm

  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel raylib git
          
      - name: Build
        run: make
        
      - name: Create Arch package
        run: |
          mkdir -p pkg/typit/usr/bin
          mkdir -p pkg/typit/usr/share/typit
          
          cp build/typer pkg/typit/usr/bin/typit
          cp -r resources pkg/typit/usr/share/typit/
          
          cat > PKGBUILD << 'EOF'
          pkgname=typit
          pkgver=1.0
          pkgrel=1
          pkgdesc="A terminal-inspired typing test application"
          arch=('x86_64')
          license=('MIT')
          depends=('raylib')
          
          package() {
            cp -r ../pkg/typit/* "$pkgdir/"
          }
          EOF
          
          useradd -m builder
          chown -R builder:builder .
          su builder -c "makepkg -f --noconfirm"
          mv *.pkg.tar.zst typit-${{ github.ref_name }}.pkg.tar.zst
          
      - name: Upload Arch artifact
        uses: actions/upload-artifact@v4
        with:
          name: typit-arch
          path: typit-${{ github.ref_name }}.pkg.tar.zst

  release:
    needs: [build-deb, build-rpm, build-arch]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            typit-deb/*.deb
            typit-rpm/*.rpm
            typit-arch/*.pkg.tar.zst
          generate_release_notes: true
